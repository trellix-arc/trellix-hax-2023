FROM ubuntu:16.04

RUN apt-get update && \
    apt-get -y install \
        wget \
        git \
        make \
        gcc \
        cron \
        rsync \
        psmisc

WORKDIR /root
COPY patches .
RUN wget --no-check-certificate https://downloads.linksys.com/downloads/gplcode/1224702713296/WUMC710_v1.0.02_build_3_GPL.tar.gz && \
    tar -xvzf WUMC710_v1.0.02_build_3_GPL.tar.gz && \
    tar -xvzf WUMC710_v1.0.02_build_3_GPL/WUMC710_v1.0.02_build_3.tgz && \
    rm -r WUMC710_v1.0.02_build_3_GPL WUMC710_v1.0.02_build_3_GPL.tar.gz

RUN git clone https://github.com/zcutlip/nvram-faker && \
    git apply --directory=nvram-faker nvram-faker.patch && \
    cd nvram-faker && \
    make && \
    mv libnvram-faker.so /usr/lib/libnvram.so && \
    mv nvram.ini /etc
RUN patch WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/shared/broadcom.c broadcom.patch && \
    cd WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/shared && \
    make SRCBASE=../.. WLAN_ComponentIncPath=-I../../shared/bcmwifi/include && \
    mv libshared.so /usr/lib
RUN cd WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/httpd && \
    sed -i 's/-L$(TOP)\/libbcmcrypto -L$(INSTALLDIR)\/libbcmcrypto\/usr\/lib -lbcmcrypto //' Makefile && \
    make TOP=.. SRCBASE=../.. WLAN_ComponentSrcDirs=../../shared/bcmwifi/src && \
    mv httpd /usr/sbin
COPY replace_vendor_strings_live.sh .
RUN chmod +x replace_vendor_strings_live.sh
RUN echo 'Project: WUMC710' > /etc/version && \
    echo 'Firmware version full: 1.0.02 build 3, Jun 25, 2014' >> /etc/version && \
    echo 'Firmware version: 1.0.02' >> /etc/version && \
    echo 'Build Date: Jun 25, 2014' >> /etc/version
RUN patch -d WUMC710_v1.0.02_build_3/SDK_Umedia/src/router -p 0 < WUMC710_web.patch && \
    cd WUMC710_v1.0.02_build_3/SDK_Umedia/src/router && \
    /root/replace_vendor_strings_live.sh && \
    cd WUMC710_web && \
    make install

# RUN rm -r WUMC710_v1.0.02_build_3 WUMC710_web.patch broadcom.patch nvram-faker nvram-faker.patch

# FIXME rsync interval to 3 maybe 5
RUN echo -n 'ARC{7h3n_y0ur_3y35_5h411_b3_0p3n3d}' > /flag && \
    cp -r /www . && \
    echo '* * * * * root rsync -a --delete /root/www /' > /etc/cron.d/restore_www

EXPOSE 80

COPY entrypoint.sh .
RUN chmod +x entrypoint.sh
ENTRYPOINT [ "./entrypoint.sh" ]

# CMD [ "/bin/bash" ]