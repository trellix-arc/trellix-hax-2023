#!/bin/bash
# readonly DEBUG=1 # NOTE: Uncomment when running locally
readonly LINKSYS_REPLACEMENT='Trellix'
readonly WUMC710_REPLACEMENT='HAX2023'
readonly VERSION_REPLACEMENT='1.3.37'

if [ -v DEBUG ]
then
    rm -rf _FW_WUMC710_v1.0.02.03_20140625.bin.extracted
    set -ex
    binwalk -e1 FW_WUMC710_v1.0.02.03_20140625.bin
    cd _FW_WUMC710_v1.0.02.03_20140625.bin.extracted/squashfs-root
else
    set -e
    cd squashfs-root
fi

# SECTION Linksys
# Modify filenames
mv www/linksys.css "www/${LINKSYS_REPLACEMENT}.css"
mv www/linksys_arabic.css "www/${LINKSYS_REPLACEMENT}_arabic.css"
rm www/image/UI_Linksys.gif

# Modify file contents
sed -i "s/[Ll]inksys/${LINKSYS_REPLACEMENT}/g" usr/lib/libshared.so
sed -i "s/[Ll]inksys/${LINKSYS_REPLACEMENT}/g" usr/sbin/httpd
grep -r 'linksys.css' | cut -d ':' -f 1 | sort -u | while read -r path
do
    sed -i "s/linksys.css/${LINKSYS_REPLACEMENT}.css/g" "${path}"
done
grep -r 'linksys_arabic.css' | cut -d ':' -f 1 | sort -u | while read -r path
do
    sed -i "s/linksys_arabic.css/${LINKSYS_REPLACEMENT}_arabic.css/g" "${path}"
done
# grep -r 'UI_Linksys.gif' | cut -d ':' -f 1 | while read -r path
# do
#     sed -i "s/UI_Linksys.gif/UI_${LINKSYS_REPLACEMENT}.gif/" "${path}"
# done
grep -r 'background-image:url(image/UI_Linksys.gif);' | cut -d ':' -f 1 | while read -r path
do
    sed -i "s/background-image:url(image\/UI_Linksys.gif);//" "${path}"
done
grep -r '<!-- Copyright (c) 2013, Linksys LLC. All Rights Reserved. -->' | cut -d ':' -f 1 | while read -r path
do
    sed -i 's/<!-- Copyright (c) 2013, Linksys LLC. All Rights Reserved. -->//' "${path}"
done
grep -r ' * Copyright (c) 2013, Linksys LLC. All Rights Reserved.' | cut -d ':' -f 1 | while read -r path
do
    sed -i 's/ * Copyright (c) 2013, Linksys LLC. All Rights Reserved.//' "${path}"
done
sed -i "s/linksys/${LINKSYS_REPLACEMENT}/" www/station/wireless_basic.asp
# LINKSYS_REPLACEMENT_HEX="$(echo -n ${LINKSYS_REPLACEMENT} | xxd -g 16 -u | cut -d ' ' -f 2)"
LINKSYS_REPLACEMENT_HEX='5472656C6C6978'
sed -i "s/6C696E6B737973/${LINKSYS_REPLACEMENT_HEX}/" www/station/wireless_basic.asp
# !SECTION Linksys

# SECTION WUMC710
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" bin/u-media_nmbd.sh
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" bin/wps_monitor
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" etc/version
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" usr/lib/libshared.so
sed -i "s/wumc710/${WUMC710_REPLACEMENT}/" usr/lib/libshared.so
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" usr/sbin/httpd
sed -i "s/WUMC710/${WUMC710_REPLACEMENT}/" www/internal_version.html
# !SECTION WUMC710

# SECTION Version
sed -i "s/1.0.02/${VERSION_REPLACEMENT}/g" etc/version
# !SECTION Version

! grep -ri linksys .
! grep -ri wumc710 .
! grep -ri 1.0.02 .

# # SECTION Interactions
sed -i 's/onChange="networkTypeChange/onChange="void/' www/station/site_survey.asp
sed -i 's/onchange="selectSecurityMode/onchange="void/' www/station/site_survey.asp www/station/wireless_basic.asp
sed -i 's/onchange="selectWEPKeyLength/onchange="void/' www/station/site_survey.asp
sed -i 's/onchange="selectWEPKeyLength_WET610N/onchange="void/' www/station/wireless_basic.asp
sed -i 's/onchange="changeLanguage/onchange="void/' www/network/sta_network.asp
sed -i 's/onChange="selectLANMode/onChange="void/' www/network/sta_network.asp
sed -i 's/onChange="selectIPv6Mode/onChange="void/' www/network/sta_network.asp

sed -i 's/updateSiteSurvey();//' www/station/site_survey.asp
# # !SECTION Interactions
