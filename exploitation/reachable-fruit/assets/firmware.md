# Creating `firmware.bin`

## Download GPL
```bash
wget --no-check-certificate https://downloads.linksys.com/downloads/gplcode/1224702713296/WUMC710_v1.0.02_build_3_GPL.tar.gz
```

## Download and extract firmware
```bash
wget --no-check-certificate https://downloads.linksys.com/downloads/firmware/1224694326986/FW_WUMC710_v1.0.02.03_20140625.bin
binwalk -e1 FW_WUMC710_v1.0.02.03_20140625.bin
```

## Replace "Linksys" and "WUMC710" mentions
```bash
readonly LINKSYS_REPLACEMENT='Trellix'
readonly WUMC710_REPLACEMENT='Hax2023'
cd _FW_WUMC710_v1.0.02.03_20140625.bin.extracted/squashfs-root

# Modify filenames

# find . | grep -i linksys
# ./www/Trellix.css
# ./www/Trellix_arabic.css
# ./www/image/UI_Trellix.gif

mv www/Trellix.css www/FIXME.css
mv www/Trellix_arabic.css www/FIXME_arabic.css
mv www/image/UI_Trellix.gif www/image/UI_FIXME.gif

# Modify file contents

# strings usr/lib/libshared.so | grep -i linksys
# linksys_20120507
# Linksys LLC
# wumc710.linksys
sed -i 's/[Ll]inksys/_FIXME_/g' usr/lib/libshared.so

# strings usr/sbin/httpd | grep -i linksys
# Content-Disposition: attachment ; filename=Linksys_WUMC710_backup.cfg
sed -i 's/[Ll]inksys/_FIXME_/g' usr/sbin/httpd


for path in $(grep -r 'Trellix.css' | cut -d ':' -f 1 | sort -u)
do
    sed -i s/Trellix.css/FIXME.css/g "${path}"
done

for path in $(grep -r 'Trellix_arabic.css' | cut -d ':' -f 1 | sort -u)
do
    sed -i s/Trellix_arabic.css/FIXME_arabic.css/g "${path}"
done

for path in $(grep -r 'UI_Trellix.gif' | cut -d ':' -f 1)
do
    sed -i s/UI_Trellix.gif/UI_FIXME.gif/ "${path}"
done

for path in $(grep -r '' | cut -d ':' -f 1)
do
    sed -i 's///' "${path}"
done

for path in $(grep -r ' *' | cut -d ':' -f 1)
do
    sed -i 's/ *//' "${path}"
done

sed -i "s/linksys/${LINKSYS_REPLACEMENT}/" www/station/wireless_basic.asp
sed -i "s/6C696E6B737973/$(echo -n ${LINKSYS_REPLACEMENT} | xxd -g 16 -u | cut -d ' ' -f 2)/" www/station/wireless_basic.asp

```

## Repack firmware
`Dockerfile`:
```Dockerfile
FROM i686/ubuntu
RUN apt update && \
    apt -y install \
        bison \
        flex \
        libz-dev \
        make
WORKDIR /root

ADD WUMC710_v1.0.02_build_3_GPL.tar.gz .
RUN tar -xzf WUMC710_v1.0.02_build_3_GPL/linux26-external-router-toolchains-gcc-4.2.3.tar.gz -C /
ENV PATH "${PATH}:/projects/hnd/tools/linux/hndtools-mipsel-linux-uclibc-4.2.3/bin"
RUN tar xzf WUMC710_v1.0.02_build_3_GPL/WUMC710_v1.0.02_build_3.tgz -C /
ENV PATH "${PATH}:/WUMC710_v1.0.02_build_3/SDK_Umedia/tools"

# LINK: https://github.com/box/augmented_types/issues/11#issuecomment-36596967
RUN ln -s /usr/lib/i386-linux-gnu/libstdc++.so.6 /usr/lib/i386-linux-gnu/libstdc++.so

RUN sed -i 's/+\$(MAKE) -C squashfs mksquashfs/+\$(MAKE) -C squashfs/' /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/Makefile

RUN cd /WUMC710_v1.0.02_build_3/SDK_Umedia/src && \
    (make -j "$(nproc)" || true)

COPY 1140B0.squashfs .
RUN /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/squashfs/unsquashfs 1140B0.squashfs && \
    echo -n 'You must not have thought it would be so easy...' > squashfs-root/www/flag && \
    /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/squashfs/mksquashfs squashfs-root 1140B0_flag.squashfs -noappend -all-root

CMD [ "/bin/bash" ]
```

<!-- `generate_firmware.sh`:
```bash
#!/bin/bash
set -ex

wget https://downloads.linksys.com/downloads/firmware/1224694326986/FW_WUMC710_v1.0.02.03_20140625.bin
binwalk -e1 FW_WUMC710_v1.0.02.03_20140625.bin
dd if=FW_WUMC710_v1.0.02.03_20140625.bin of=firmware_wo_fs.bin bs=1 count=1130672
mv _FW_WUMC710_v1.0.02.03_20140625.bin.extracted/*.squashfs .

readonly IMAGE_TAG='wumc710-toolchain'
wget https://downloads.linksys.com/downloads/gplcode/1224702713296/WUMC710_v1.0.02_build_3_GPL.tar.gz
docker build -t "${IMAGE_TAG}" .
docker run --rm -d  "${IMAGE_TAG}" sleep infinity
container_id="$(docker container ls | grep ${IMAGE_TAG} | cut -d ' ' -f 1)"
docker cp "${container_id}:/root/1140B0_flag.squashfs" fs.bin
docker rm -f "${container_id}"

cat firmware_wo_fs.bin fs.bin > firmware.bin
``` -->



## Caveats

**No attempt is made to fix the following values in the TRX firmware header**:
- image size: 3960832 bytes
- CRC32: 0x3C308E00

```bash
binwalk FW_WUMC710_v1.0.02.03_20140625.bin

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             TRX firmware header, little endian, image size: 3960832 bytes, CRC32: 0x3C308E00, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x1140B0, rootfs offset: 0x0
28            0x1C            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 3408005 bytes
1130672       0x1140B0        Squashfs filesystem, little endian, non-standard signature, version 3.0, size: 2823204 bytes, 255 inodes, blocksize: 65536 bytes, created: 2014-06-25 03:01:45

binwalk firmware.bin

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             TRX firmware header, little endian, image size: 3960832 bytes, CRC32: 0x3C308E00, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x1140B0, rootfs offset: 0x0
28            0x1C            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 3408005 bytes
1130672       0x1140B0        Squashfs filesystem, little endian, non-standard signature, version 3.0, size: 2823271 bytes, 256 inodes, blocksize: 65536 bytes, created: 2022-10-25 19:23:16

```
