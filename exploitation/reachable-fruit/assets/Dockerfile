FROM i686/ubuntu
RUN apt update && \
    apt -y install \
        bison \
        flex \
        libz-dev \
        make

WORKDIR /root
ADD WUMC710_v1.0.02_build_3_GPL.tar.gz .
RUN tar -xzf WUMC710_v1.0.02_build_3_GPL/linux26-external-router-toolchains-gcc-4.2.3.tar.gz -C /
ENV PATH "${PATH}:/projects/hnd/tools/linux/hndtools-mipsel-linux-uclibc-4.2.3/bin"
RUN tar -xzf WUMC710_v1.0.02_build_3_GPL/WUMC710_v1.0.02_build_3.tgz -C /
ENV PATH "${PATH}:/WUMC710_v1.0.02_build_3/SDK_Umedia/tools"
RUN rm -r WUMC710_v1.0.02_build_3_GPL

# LINK: https://github.com/box/augmented_types/issues/11#issuecomment-36596967
RUN ln -s /usr/lib/i386-linux-gnu/libstdc++.so.6 /usr/lib/i386-linux-gnu/libstdc++.so
RUN sed -i 's/+\$(MAKE) -C squashfs mksquashfs/+\$(MAKE) -C squashfs/' /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/Makefile
RUN make -C /WUMC710_v1.0.02_build_3/SDK_Umedia/src -j "$(nproc)"
RUN find /WUMC710_v1.0.02_build_3 -name unsquashfs && \
    find /WUMC710_v1.0.02_build_3 -name mksquashfs

COPY _FW_WUMC710_v1.0.02.03_20140625.bin.extracted/1140B0.squashfs .
COPY replace_vendor_strings.sh .
RUN /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/squashfs/unsquashfs 1140B0.squashfs && \
    chmod +x replace_vendor_strings.sh && \
    ./replace_vendor_strings.sh && \
    echo -n 'You must not have thought it would be _that_ easy...' > squashfs-root/flag && \
    /WUMC710_v1.0.02_build_3/SDK_Umedia/src/router/squashfs/mksquashfs squashfs-root fs.bin -noappend -all-root && \
    chmod -x fs.bin && \
    rm 1140B0.squashfs replace_vendor_strings.sh && \
    rm -r squashfs-root

COPY FW_WUMC710_v1.0.02.03_20140625.bin .
RUN dd if=FW_WUMC710_v1.0.02.03_20140625.bin of=firmware_no_fs.bin bs=1 count=1130672 && \
    cat firmware_no_fs.bin fs.bin > firmware.bin && \
    rm FW_WUMC710_v1.0.02.03_20140625.bin firmware_no_fs.bin fs.bin

CMD [ "/bin/bash" ]